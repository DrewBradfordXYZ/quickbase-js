<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickBase App Explorer - Vue</title>
  <script src="https://cdn.jsdelivr.net/npm/quickbase-js@2/dist/quickbase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <style>
    :root {
      --qb-primary: #2196f3;
      --qb-primary-dark: #1976d2;
      --qb-error: #f44336;
      --qb-bg: #f5f5f5;
      --qb-card-bg: #ffffff;
      --qb-text: #333333;
      --qb-text-muted: #666666;
      --qb-border: #e0e0e0;
      --qb-radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--qb-bg);
      color: var(--qb-text);
      margin: 0;
      padding: 16px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--qb-border);
    }
    .header h1 { margin: 0; font-size: 24px; }
    .meta { color: var(--qb-text-muted); font-size: 14px; }
    .card {
      background: var(--qb-card-bg);
      border-radius: var(--qb-radius);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--qb-bg);
      border-bottom: 1px solid var(--qb-border);
      cursor: pointer;
    }
    .card-header:hover { background: #eeeeee; }
    .card-header h2 { margin: 0; font-size: 16px; font-weight: 600; }
    .card-body { padding: 16px; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      background: #e3f2fd;
      color: var(--qb-primary-dark);
      margin-left: 4px;
    }
    .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .data-table th, .data-table td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid var(--qb-border);
    }
    .data-table th {
      background: var(--qb-bg);
      font-weight: 600;
      color: var(--qb-text-muted);
      font-size: 12px;
      text-transform: uppercase;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--qb-text-muted);
    }
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--qb-border);
      border-top-color: var(--qb-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error {
      background: #ffebee;
      color: var(--qb-error);
      padding: 16px;
      border-radius: var(--qb-radius);
      margin: 16px 0;
    }
    .field-type {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #eeeeee;
      color: var(--qb-text-muted);
    }
    .stats { display: flex; gap: 32px; }
    .stat-value { font-size: 32px; font-weight: 700; color: var(--qb-primary); }
    .stat-label { font-size: 12px; color: var(--qb-text-muted); text-transform: uppercase; }
    .expand-icon {
      display: inline-block;
      transition: transform 0.2s;
      margin-right: 8px;
    }
    .expand-icon.expanded { transform: rotate(90deg); }
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--qb-border); margin-bottom: 16px; }
    .tab {
      padding: 8px 16px;
      border: none;
      background: none;
      font-size: 14px;
      color: var(--qb-text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab:hover { color: var(--qb-text); }
    .tab.active { color: var(--qb-primary); border-bottom-color: var(--qb-primary); }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <script>
    const { createApp, ref, reactive, computed, onMounted, provide, inject, watch } = Vue;

    // ============================================
    // QuickBase Composables
    // ============================================
    const QBClientKey = Symbol('qb-client');

    function createQBClient() {
      const realm = window.location.hostname.split('.')[0];
      const appId = window.location.pathname.match(/\/db\/([^/?]+)/)?.[1];

      if (!realm || !appId) {
        throw new Error('Could not detect realm/appId from URL');
      }

      const client = QuickBase.createClient({
        realm,
        auth: { type: 'temp-token' }
      });

      return { client, realm, appId };
    }

    function useQB() {
      return inject(QBClientKey);
    }

    function useApp() {
      const { client, appId } = useQB();
      const app = ref(null);
      const loading = ref(true);
      const error = ref(null);

      onMounted(async () => {
        try {
          app.value = await client.getApp({ appId });
        } catch (e) {
          error.value = e.message;
        } finally {
          loading.value = false;
        }
      });

      return { app, loading, error };
    }

    function useTables() {
      const { client, appId } = useQB();
      const tables = ref([]);
      const loading = ref(true);
      const error = ref(null);

      onMounted(async () => {
        try {
          tables.value = await client.getAppTables({ appId });
        } catch (e) {
          error.value = e.message;
        } finally {
          loading.value = false;
        }
      });

      return { tables, loading, error };
    }

    function useTableDetails(tableId, enabled) {
      const { client } = useQB();
      const fields = ref(null);
      const records = ref(null);
      const loading = ref(false);
      const error = ref(null);
      const loaded = ref(false);

      watch(enabled, async (isEnabled) => {
        if (!isEnabled || loaded.value) return;

        loading.value = true;
        try {
          const [fieldsData, queryResult] = await Promise.all([
            client.getFields({ tableId }),
            client.runQuery({
              from: tableId,
              select: [3, 1, 2],
              sortBy: [{ fieldId: 2, order: 'DESC' }],
              options: { top: 5 }
            })
          ]);

          fields.value = fieldsData;
          records.value = queryResult.data || [];
          loaded.value = true;
        } catch (e) {
          error.value = e.message;
        } finally {
          loading.value = false;
        }
      }, { immediate: true });

      return { fields, records, loading, error };
    }

    // ============================================
    // Utility Functions
    // ============================================
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

      return date.toLocaleDateString();
    }

    // ============================================
    // Components
    // ============================================
    const LoadingSpinner = {
      props: ['message'],
      template: `
        <div class="loading">
          <div class="spinner"></div>
          {{ message || 'Loading...' }}
        </div>
      `
    };

    const ErrorMessage = {
      props: ['message'],
      template: `<div class="error">{{ message }}</div>`
    };

    const FieldsTable = {
      props: ['fields'],
      template: `
        <p v-if="!fields?.length" class="meta">No fields found</p>
        <table v-else class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Label</th>
              <th>Type</th>
              <th>Properties</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="f in fields" :key="f.id">
              <td>{{ f.id }}</td>
              <td>{{ f.label }}</td>
              <td><span class="field-type">{{ f.fieldType }}</span></td>
              <td>
                <span v-if="f.required" class="badge">required</span>
                <span v-if="f.unique" class="badge">unique</span>
                <span v-if="f.properties?.formula" class="badge">formula</span>
              </td>
            </tr>
          </tbody>
        </table>
      `
    };

    const RecordsTable = {
      props: ['records'],
      setup() {
        return { formatDate };
      },
      template: `
        <p v-if="!records?.length" class="meta">No records found</p>
        <table v-else class="data-table">
          <thead>
            <tr>
              <th>Record ID</th>
              <th>Created</th>
              <th>Modified</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="r in records" :key="r['3']?.value">
              <td>{{ r['3']?.value || '-' }}</td>
              <td>{{ formatDate(r['1']?.value) }}</td>
              <td>{{ formatDate(r['2']?.value) }}</td>
            </tr>
          </tbody>
        </table>
      `
    };

    const TableCard = {
      props: ['table'],
      components: { LoadingSpinner, ErrorMessage, FieldsTable, RecordsTable },
      setup(props) {
        const expanded = ref(false);
        const activeTab = ref('fields');
        const { fields, records, loading, error } = useTableDetails(
          props.table.id,
          expanded
        );

        const fieldCount = computed(() => fields.value?.length || '...');

        const toggle = () => {
          expanded.value = !expanded.value;
        };

        return {
          expanded,
          activeTab,
          fields,
          records,
          loading,
          error,
          fieldCount,
          toggle
        };
      },
      template: `
        <div class="card">
          <div class="card-header" @click="toggle">
            <h2>
              <span :class="['expand-icon', { expanded }]">â–¶</span>
              {{ table.name }}
            </h2>
            <span class="badge">{{ fieldCount }} fields</span>
          </div>

          <div v-if="expanded" class="card-body">
            <LoadingSpinner v-if="loading" message="Loading table details..." />
            <ErrorMessage v-else-if="error" :message="error" />
            <template v-else>
              <div class="tabs">
                <button
                  :class="['tab', { active: activeTab === 'fields' }]"
                  @click="activeTab = 'fields'"
                >
                  Fields ({{ fields?.length || 0 }})
                </button>
                <button
                  :class="['tab', { active: activeTab === 'records' }]"
                  @click="activeTab = 'records'"
                >
                  Recent Records ({{ records?.length || 0 }})
                </button>
              </div>
              <FieldsTable v-if="activeTab === 'fields'" :fields="fields" />
              <RecordsTable v-else :records="records" />
            </template>
          </div>
        </div>
      `
    };

    const AppExplorer = {
      components: { LoadingSpinner, ErrorMessage, TableCard },
      setup() {
        const qb = useQB();
        const { app, loading: appLoading, error: appError } = useApp();
        const { tables, loading: tablesLoading, error: tablesError } = useTables();

        const loading = computed(() => appLoading.value || tablesLoading.value);
        const error = computed(() => appError.value || tablesError.value);

        return { qb, app, tables, loading, error };
      },
      template: `
        <LoadingSpinner v-if="loading" message="Loading app..." />
        <ErrorMessage v-else-if="error" :message="error" />
        <template v-else>
          <div class="header">
            <div>
              <h1>{{ app.name }}</h1>
              <div class="meta">{{ qb.realm }}.quickbase.com</div>
              <div class="meta">Vue 3</div>
            </div>
            <div class="stats">
              <div class="stat">
                <div class="stat-value">{{ tables.length }}</div>
                <div class="stat-label">Tables</div>
              </div>
            </div>
          </div>

          <TableCard v-for="table in tables" :key="table.id" :table="table" />
        </template>
      `
    };

    // ============================================
    // App Root
    // ============================================
    const App = {
      components: { AppExplorer, ErrorMessage },
      setup() {
        const error = ref(null);

        try {
          const qbClient = createQBClient();
          provide(QBClientKey, qbClient);
        } catch (e) {
          error.value = e.message;
        }

        return { error };
      },
      template: `
        <ErrorMessage v-if="error" :message="error" />
        <AppExplorer v-else />
      `
    };

    createApp(App).mount('#app');
  </script>
</body>
</html>
