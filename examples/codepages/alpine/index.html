<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickBase App Explorer - Alpine.js</title>
  <script src="https://cdn.jsdelivr.net/npm/quickbase-js@2/dist/quickbase.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
  <style>
    :root {
      --qb-primary: #2196f3;
      --qb-primary-dark: #1976d2;
      --qb-error: #f44336;
      --qb-bg: #f5f5f5;
      --qb-card-bg: #ffffff;
      --qb-text: #333333;
      --qb-text-muted: #666666;
      --qb-border: #e0e0e0;
      --qb-radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--qb-bg);
      color: var(--qb-text);
      margin: 0;
      padding: 16px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--qb-border);
    }
    .header h1 { margin: 0; font-size: 24px; }
    .meta { color: var(--qb-text-muted); font-size: 14px; }
    .card {
      background: var(--qb-card-bg);
      border-radius: var(--qb-radius);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--qb-bg);
      border-bottom: 1px solid var(--qb-border);
      cursor: pointer;
    }
    .card-header:hover { background: #eeeeee; }
    .card-header h2 { margin: 0; font-size: 16px; font-weight: 600; }
    .card-body { padding: 16px; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      background: #e3f2fd;
      color: var(--qb-primary-dark);
      margin-left: 4px;
    }
    .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .data-table th, .data-table td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid var(--qb-border);
    }
    .data-table th {
      background: var(--qb-bg);
      font-weight: 600;
      color: var(--qb-text-muted);
      font-size: 12px;
      text-transform: uppercase;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--qb-text-muted);
    }
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--qb-border);
      border-top-color: var(--qb-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error {
      background: #ffebee;
      color: var(--qb-error);
      padding: 16px;
      border-radius: var(--qb-radius);
      margin: 16px 0;
    }
    .field-type {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #eeeeee;
      color: var(--qb-text-muted);
    }
    .stats { display: flex; gap: 32px; }
    .stat-value { font-size: 32px; font-weight: 700; color: var(--qb-primary); }
    .stat-label { font-size: 12px; color: var(--qb-text-muted); text-transform: uppercase; }
    .expand-icon {
      display: inline-block;
      transition: transform 0.2s;
      margin-right: 8px;
    }
    .expand-icon.expanded { transform: rotate(90deg); }
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--qb-border); margin-bottom: 16px; }
    .tab {
      padding: 8px 16px;
      border: none;
      background: none;
      font-size: 14px;
      color: var(--qb-text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab:hover { color: var(--qb-text); }
    .tab.active { color: var(--qb-primary); border-bottom-color: var(--qb-primary); }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body>
  <div class="container" x-data="appExplorer()" x-init="init()">
    <!-- Loading State -->
    <template x-if="loading">
      <div class="loading">
        <div class="spinner"></div>
        Loading app...
      </div>
    </template>

    <!-- Error State -->
    <template x-if="error">
      <div class="error" x-text="error"></div>
    </template>

    <!-- App Content -->
    <template x-if="!loading && !error">
      <div>
        <!-- Header -->
        <div class="header">
          <div>
            <h1 x-text="app?.name"></h1>
            <div class="meta" x-text="realm + '.quickbase.com'"></div>
            <div class="meta">Alpine.js</div>
          </div>
          <div class="stats">
            <div class="stat">
              <div class="stat-value" x-text="tables.length"></div>
              <div class="stat-label">Tables</div>
            </div>
          </div>
        </div>

        <!-- Tables -->
        <template x-for="table in tables" :key="table.id">
          <div class="card" x-data="tableCard(table)">
            <div class="card-header" @click="toggle()">
              <h2>
                <span class="expand-icon" :class="{ expanded }">â–¶</span>
                <span x-text="table.name"></span>
              </h2>
              <span class="badge" x-text="(fields?.length || '...') + ' fields'"></span>
            </div>

            <template x-if="expanded">
              <div class="card-body">
                <!-- Loading -->
                <template x-if="detailLoading">
                  <div class="loading">
                    <div class="spinner"></div>
                    Loading table details...
                  </div>
                </template>

                <!-- Error -->
                <template x-if="detailError">
                  <div class="error" x-text="detailError"></div>
                </template>

                <!-- Content -->
                <template x-if="!detailLoading && !detailError && fields">
                  <div>
                    <div class="tabs">
                      <button class="tab" :class="{ active: activeTab === 'fields' }"
                              @click="activeTab = 'fields'">
                        Fields (<span x-text="fields?.length || 0"></span>)
                      </button>
                      <button class="tab" :class="{ active: activeTab === 'records' }"
                              @click="activeTab = 'records'">
                        Recent Records (<span x-text="records?.length || 0"></span>)
                      </button>
                    </div>

                    <!-- Fields Table -->
                    <template x-if="activeTab === 'fields'">
                      <table class="data-table">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Label</th>
                            <th>Type</th>
                            <th>Properties</th>
                          </tr>
                        </thead>
                        <tbody>
                          <template x-for="f in fields" :key="f.id">
                            <tr>
                              <td x-text="f.id"></td>
                              <td x-text="f.label"></td>
                              <td><span class="field-type" x-text="f.fieldType"></span></td>
                              <td>
                                <span x-show="f.required" class="badge">required</span>
                                <span x-show="f.unique" class="badge">unique</span>
                                <span x-show="f.properties?.formula" class="badge">formula</span>
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </template>

                    <!-- Records Table -->
                    <template x-if="activeTab === 'records'">
                      <div>
                        <p x-show="!records?.length" class="meta">No records found</p>
                        <table x-show="records?.length" class="data-table">
                          <thead>
                            <tr>
                              <th>Record ID</th>
                              <th>Created</th>
                              <th>Modified</th>
                            </tr>
                          </thead>
                          <tbody>
                            <template x-for="r in records" :key="r['3']?.value">
                              <tr>
                                <td x-text="r['3']?.value || '-'"></td>
                                <td x-text="formatDate(r['1']?.value)"></td>
                                <td x-text="formatDate(r['2']?.value)"></td>
                              </tr>
                            </template>
                          </tbody>
                        </table>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>
    </template>
  </div>

  <script>
    // ============================================
    // QuickBase Client (Global)
    // ============================================
    const QB = {
      client: null,
      realm: null,
      appId: null,

      init() {
        this.realm = window.location.hostname.split('.')[0];
        this.appId = window.location.pathname.match(/\/db\/([^/?]+)/)?.[1];

        if (!this.realm || !this.appId) {
          throw new Error('Could not detect realm/appId from URL');
        }

        this.client = QuickBase.createClient({
          realm: this.realm,
          auth: { type: 'temp-token' }
        });

        return this;
      }
    };

    // ============================================
    // Utility Functions
    // ============================================
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

      return date.toLocaleDateString();
    }

    // ============================================
    // Alpine Components
    // ============================================
    function appExplorer() {
      return {
        loading: true,
        error: null,
        app: null,
        tables: [],
        realm: '',

        async init() {
          try {
            QB.init();
            this.realm = QB.realm;

            const [app, tables] = await Promise.all([
              QB.client.getApp({ appId: QB.appId }),
              QB.client.getAppTables({ appId: QB.appId })
            ]);

            this.app = app;
            this.tables = tables;
            this.loading = false;
          } catch (e) {
            this.error = e.message;
            this.loading = false;
          }
        }
      };
    }

    function tableCard(table) {
      return {
        expanded: false,
        activeTab: 'fields',
        fields: null,
        records: null,
        detailLoading: false,
        detailError: null,

        formatDate,

        async toggle() {
          this.expanded = !this.expanded;

          if (this.expanded && !this.fields) {
            this.detailLoading = true;

            try {
              const [fields, queryResult] = await Promise.all([
                QB.client.getFields({ tableId: table.id }),
                QB.client.runQuery({
                  from: table.id,
                  select: [3, 1, 2],
                  sortBy: [{ fieldId: 2, order: 'DESC' }],
                  options: { top: 5 }
                })
              ]);

              this.fields = fields;
              this.records = queryResult.data || [];
              this.detailLoading = false;
            } catch (e) {
              this.detailError = e.message;
              this.detailLoading = false;
            }
          }
        }
      };
    }
  </script>
</body>
</html>
